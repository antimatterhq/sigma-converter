{
  "metadata": {
    "name": "Suspicious Child Process Of SQL Server",
    "comment": "Detects suspicious child processes of the SQLServer process. This could indicate potential RCE or SQL Injection.",
    "annotations": {
      "source": "sigma",
      "category": "process_creation",
      "product": "windows",
      "sigma_status": "test"
    }
  },
  "spec": {
    "schedule": {
      "atLeastEvery": "15m",
      "enabled": true
    },
    "input": {
      "batch": {
        "sql": "SELECT * FROM process_activity WHERE time BETWEEN CURRENT_TIMESTAMP() - INTERVAL 24 HOUR AND CURRENT_TIMESTAMP() AND (lower(activity_id) = lower('1') AND endswith(lower(process.parent_process.name), lower('\\\\sqlservr.exe')) AND (endswith(lower(process.name), lower('\\\\bash.exe')) OR endswith(lower(process.name), lower('\\\\bitsadmin.exe')) OR endswith(lower(process.name), lower('\\\\cmd.exe')) OR endswith(lower(process.name), lower('\\\\netstat.exe')) OR endswith(lower(process.name), lower('\\\\nltest.exe')) OR endswith(lower(process.name), lower('\\\\ping.exe')) OR endswith(lower(process.name), lower('\\\\powershell.exe')) OR endswith(lower(process.name), lower('\\\\pwsh.exe')) OR endswith(lower(process.name), lower('\\\\regsvr32.exe')) OR endswith(lower(process.name), lower('\\\\rundll32.exe')) OR endswith(lower(process.name), lower('\\\\sh.exe')) OR endswith(lower(process.name), lower('\\\\systeminfo.exe')) OR endswith(lower(process.name), lower('\\\\tasklist.exe')) OR endswith(lower(process.name), lower('\\\\wsl.exe'))) AND NOT (startswith(lower(process.parent_process.name), lower('c:\\\\program files\\\\microsoft sql server\\\\')) AND endswith(lower(process.parent_process.name), lower('datev_dbengine\\\\mssql\\\\binn\\\\sqlservr.exe')) AND lower(process.name) = lower('c:\\\\windows\\\\system32\\\\cmd.exe') AND startswith(lower(process.cmd_line), lower('\"c:\\\\windows\\\\system32\\\\cmd.exe\" '))))"
      }
    },
    "output": {
      "summary": "Detects suspicious child processes of the SQLServer process. This could indicate potential RCE or SQL Injection.",
      "defaultContext": true
    },
    "metadata": {
      "version": 1.0,
      "severity": "High",
      "fidelity": "Investigative",
      "objective": "Reference: Internal Research",
      "mitre": [
        {
          "taxonomy": "MITRE ATT&CK",
          "tactic": "Initial-Access",
          "techniqueId": "T1505",
          "subTechniqueId": "003"
        },
        {
          "taxonomy": "MITRE ATT&CK",
          "tactic": "Initial-Access",
          "techniqueId": "T1190"
        }
      ]
    },
    "computeMode": "high"
  },
  "apiVersion": "v1",
  "kind": "Rule"
}