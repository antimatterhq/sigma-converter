{
  "metadata": {
    "name": "Azure Kubernetes CronJob",
    "comment": "Identifies when a Azure Kubernetes CronJob runs in Azure Cloud. Kubernetes Job is a controller that creates one or more pods and ensures that a specified number of them successfully terminate. Kubernetes Job can be used to run containers that perform finite tasks for batch jobs. Kubernetes CronJob is used to schedule Jobs. An Adversary may use Kubernetes CronJob for scheduling execution of malicious code that would run as a container in the cluster.",
    "annotations": {
      "source": "sigma",
      "product": "azure",
      "service": "activitylogs",
      "sigma_status": "test"
    }
  },
  "spec": {
    "schedule": {
      "atLeastEvery": "15m",
      "enabled": true
    },
    "input": {
      "batch": {
        "sql": "SELECT * FROM entity_management WHERE time BETWEEN CURRENT_TIMESTAMP() - INTERVAL 24 HOUR AND CURRENT_TIMESTAMP() AND ((startswith(lower(api.operation), lower('microsoft.kubernetes/connectedclusters/batch')) OR startswith(lower(api.operation), lower('microsoft.containerservice/managedclusters/batch'))) AND (endswith(lower(api.operation), lower('/cronjobs/write')) OR endswith(lower(api.operation), lower('/jobs/write'))))"
      }
    },
    "output": {
      "summary": "Identifies when a Azure Kubernetes CronJob runs in Azure Cloud. Kubernetes Job is a controller that creates one or more pods and ensures that a specified number of them successfully terminate. Kubernetes Job can be used to run containers that perform finite tasks for batch jobs. Kubernetes CronJob is used to schedule Jobs. An Adversary may use Kubernetes CronJob for scheduling execution of malicious code that would run as a container in the cluster.",
      "defaultContext": true
    },
    "metadata": {
      "version": 1.0,
      "severity": "Medium",
      "fidelity": "Investigative",
      "objective": "False positives: 1. Azure Kubernetes CronJob/Job may be done by a system administrator. 2. If known behavior is causing false positives, it can be exempted from the rule. References: https://learn.microsoft.com/en-us/azure/role-based-access-control/resource-provider-operations#microsoftkubernetes, https://kubernetes.io/docs/concepts/workloads/controllers/cron-jobs/, https://kubernetes.io/docs/concepts/workloads/controllers/job/, https://www.microsoft.com/security/blog/2020/04/02/attack-matrix-kubernetes/",
      "mitre": [
        {
          "taxonomy": "MITRE ATT&CK",
          "tactic": "Persistence",
          "techniqueId": "T1053",
          "subTechniqueId": "003"
        }
      ]
    },
    "computeMode": "high"
  },
  "apiVersion": "v1",
  "kind": "Rule"
}