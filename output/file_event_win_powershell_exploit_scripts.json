{
  "metadata": {
    "name": "Malicious PowerShell Scripts - FileCreation",
    "comment": "Detects the creation of known offensive powershell scripts used for exploitation",
    "annotations": {
      "source": "sigma",
      "category": "file_event",
      "product": "windows",
      "sigma_status": "test"
    }
  },
  "spec": {
    "schedule": {
      "atLeastEvery": "15m",
      "enabled": true
    },
    "input": {
      "batch": {
        "sql": "SELECT * FROM file_activity WHERE time BETWEEN CURRENT_TIMESTAMP() - INTERVAL 24 HOUR AND CURRENT_TIMESTAMP() AND (lower(activity_id) = lower('1') AND (endswith(lower(file.path), lower('\\\\add-constraineddelegationbackdoor.ps1')) OR endswith(lower(file.path), lower('\\\\add-exfiltration.ps1')) OR endswith(lower(file.path), lower('\\\\add-persistence.ps1')) OR endswith(lower(file.path), lower('\\\\add-regbackdoor.ps1')) OR endswith(lower(file.path), lower('\\\\add-remoteregbackdoor.ps1')) OR endswith(lower(file.path), lower('\\\\add-scrnsavebackdoor.ps1')) OR endswith(lower(file.path), lower('\\\\adrecon.ps1')) OR endswith(lower(file.path), lower('\\\\azureadrecon.ps1')) OR endswith(lower(file.path), lower('\\\\check-vm.ps1')) OR endswith(lower(file.path), lower('\\\\convertto-rot13.ps1')) OR endswith(lower(file.path), lower('\\\\copy-vss.ps1')) OR endswith(lower(file.path), lower('\\\\create-multiplesessions.ps1')) OR endswith(lower(file.path), lower('\\\\dns_txt_pwnage.ps1')) OR endswith(lower(file.path), lower('\\\\dnscat2.ps1')) OR endswith(lower(file.path), lower('\\\\do-exfiltration.ps1')) OR endswith(lower(file.path), lower('\\\\domainpasswordspray.ps1')) OR endswith(lower(file.path), lower('\\\\download_execute.ps1')) OR endswith(lower(file.path), lower('\\\\download-execute-ps.ps1')) OR endswith(lower(file.path), lower('\\\\enable-duplicatetoken.ps1')) OR endswith(lower(file.path), lower('\\\\enabled-duplicatetoken.ps1')) OR endswith(lower(file.path), lower('\\\\execute-command-mssql.ps1')) OR endswith(lower(file.path), lower('\\\\execute-dnstxt-code.ps1')) OR endswith(lower(file.path), lower('\\\\execute-ontime.ps1')) OR endswith(lower(file.path), lower('\\\\exetotext.ps1')) OR endswith(lower(file.path), lower('\\\\exploit-jboss.ps1')) OR endswith(lower(file.path), lower('\\\\find-avsignature.ps1')) OR endswith(lower(file.path), lower('\\\\find-fruit.ps1')) OR endswith(lower(file.path), lower('\\\\find-gpolocation.ps1')) OR endswith(lower(file.path), lower('\\\\find-trusteddocuments.ps1')) OR endswith(lower(file.path), lower('\\\\firebuster.ps1')) OR endswith(lower(file.path), lower('\\\\firelistener.ps1')) OR endswith(lower(file.path), lower('\\\\get-applicationhost.ps1')) OR endswith(lower(file.path), lower('\\\\get-chromedump.ps1')) OR endswith(lower(file.path), lower('\\\\get-clipboardcontents.ps1')) OR endswith(lower(file.path), lower('\\\\get-computerdetail.ps1')) OR endswith(lower(file.path), lower('\\\\get-foxdump.ps1')) OR endswith(lower(file.path), lower('\\\\get-gppautologon.ps1')) OR endswith(lower(file.path), lower('\\\\get-gpppassword.ps1')) OR endswith(lower(file.path), lower('\\\\get-indexeditem.ps1')) OR endswith(lower(file.path), lower('\\\\get-keystrokes.ps1')) OR endswith(lower(file.path), lower('\\\\get-lsasecret.ps1')) OR endswith(lower(file.path), lower('\\\\get-microphoneaudio.ps1')) OR endswith(lower(file.path), lower('\\\\get-passhashes.ps1')) OR endswith(lower(file.path), lower('\\\\get-passhints.ps1')) OR endswith(lower(file.path), lower('\\\\get-regalwaysinstallelevated.ps1')) OR endswith(lower(file.path), lower('\\\\get-regautologon.ps1')) OR endswith(lower(file.path), lower('\\\\get-rickastley.ps1')) OR endswith(lower(file.path), lower('\\\\get-screenshot.ps1')) OR endswith(lower(file.path), lower('\\\\get-securitypackages.ps1')) OR endswith(lower(file.path), lower('\\\\get-servicefilepermission.ps1')) OR endswith(lower(file.path), lower('\\\\get-servicepermission.ps1')) OR endswith(lower(file.path), lower('\\\\get-serviceunquoted.ps1')) OR endswith(lower(file.path), lower('\\\\get-sitelistpassword.ps1')) OR endswith(lower(file.path), lower('\\\\get-system.ps1')) OR endswith(lower(file.path), lower('\\\\get-timedscreenshot.ps1')) OR endswith(lower(file.path), lower('\\\\get-unattendedinstallfile.ps1')) OR endswith(lower(file.path), lower('\\\\get-unconstrained.ps1')) OR endswith(lower(file.path), lower('\\\\get-usbkeystrokes.ps1')) OR endswith(lower(file.path), lower('\\\\get-vaultcredential.ps1')) OR endswith(lower(file.path), lower('\\\\get-vulnautorun.ps1')) OR endswith(lower(file.path), lower('\\\\get-vulnschtask.ps1')) OR endswith(lower(file.path), lower('\\\\get-webconfig.ps1')) OR endswith(lower(file.path), lower('\\\\get-webcredentials.ps1')) OR endswith(lower(file.path), lower('\\\\get-wlan-keys.ps1')) OR endswith(lower(file.path), lower('\\\\gupt-backdoor.ps1')) OR endswith(lower(file.path), lower('\\\\http-backdoor.ps1')) OR endswith(lower(file.path), lower('\\\\http-login.ps1')) OR endswith(lower(file.path), lower('\\\\install-servicebinary.ps1')) OR endswith(lower(file.path), lower('\\\\install-ssp.ps1')) OR endswith(lower(file.path), lower('\\\\invoke-aclscanner.ps1')) OR endswith(lower(file.path), lower('\\\\invoke-adsbackdoor.ps1')) OR endswith(lower(file.path), lower('\\\\invoke-amsibypass.ps1')) OR endswith(lower(file.path), lower('\\\\invoke-arpscan.ps1')) OR endswith(lower(file.path), lower('\\\\invoke-backdoorlnk.ps1')) OR endswith(lower(file.path), lower('\\\\invoke-badpotato.ps1')) OR endswith(lower(file.path), lower('\\\\invoke-bettersafetykatz.ps1')) OR endswith(lower(file.path), lower('\\\\invoke-bruteforce.ps1')) OR endswith(lower(file.path), lower('\\\\invoke-bypassuac.ps1')) OR endswith(lower(file.path), lower('\\\\invoke-carbuncle.ps1')) OR endswith(lower(file.path), lower('\\\\invoke-certify.ps1')) OR endswith(lower(file.path), lower('\\\\invoke-conptyshell.ps1')) OR endswith(lower(file.path), lower('\\\\invoke-credentialinjection.ps1')) OR endswith(lower(file.path), lower('\\\\invoke-credentialsphish.ps1')) OR endswith(lower(file.path), lower('\\\\invoke-daft.ps1')) OR endswith(lower(file.path), lower('\\\\invoke-dcsync.ps1')) OR endswith(lower(file.path), lower('\\\\invoke-decode.ps1')) OR endswith(lower(file.path), lower('\\\\invoke-dinvokekatz.ps1')) OR endswith(lower(file.path), lower('\\\\invoke-dllinjection.ps1')) OR endswith(lower(file.path), lower('\\\\invoke-dnsupdate.ps1')) OR endswith(lower(file.path), lower('\\\\invoke-downgradeaccount.ps1')) OR endswith(lower(file.path), lower('\\\\invoke-egresscheck.ps1')) OR endswith(lower(file.path), lower('\\\\invoke-encode.ps1')) OR endswith(lower(file.path), lower('\\\\invoke-eventviewer.ps1')) OR endswith(lower(file.path), lower('\\\\invoke-eyewitness.ps1')) OR endswith(lower(file.path), lower('\\\\invoke-fakelogonscreen.ps1')) OR endswith(lower(file.path), lower('\\\\invoke-farmer.ps1')) OR endswith(lower(file.path), lower('\\\\invoke-get-rbcd-threaded.ps1')) OR endswith(lower(file.path), lower('\\\\invoke-gopher.ps1')) OR endswith(lower(file.path), lower('\\\\invoke-grouper2.ps1')) OR endswith(lower(file.path), lower('\\\\invoke-grouper3.ps1')) OR endswith(lower(file.path), lower('\\\\invoke-handlekatz.ps1')) OR endswith(lower(file.path), lower('\\\\invoke-interceptor.ps1')) OR endswith(lower(file.path), lower('\\\\invoke-internalmonologue.ps1')) OR endswith(lower(file.path), lower('\\\\invoke-inveigh.ps1')) OR endswith(lower(file.path), lower('\\\\invoke-inveighrelay.ps1')) OR endswith(lower(file.path), lower('\\\\invoke-jsratregsvr.ps1')) OR endswith(lower(file.path), lower('\\\\invoke-jsratrundll.ps1')) OR endswith(lower(file.path), lower('\\\\invoke-krbrelay.ps1')) OR endswith(lower(file.path), lower('\\\\invoke-krbrelayup.ps1')) OR endswith(lower(file.path), lower('\\\\invoke-ldapsigncheck.ps1')) OR endswith(lower(file.path), lower('\\\\invoke-lockless.ps1')) OR endswith(lower(file.path), lower('\\\\invoke-malsccm.ps1')) OR endswith(lower(file.path), lower('\\\\invoke-mimikatz.ps1')) OR endswith(lower(file.path), lower('\\\\invoke-mimikatzwdigestdowngrade.ps1')) OR endswith(lower(file.path), lower('\\\\invoke-mimikittenz.ps1')) OR endswith(lower(file.path), lower('\\\\invoke-mitm6.ps1')) OR endswith(lower(file.path), lower('\\\\invoke-nanodump.ps1')) OR endswith(lower(file.path), lower('\\\\invoke-netripper.ps1')) OR endswith(lower(file.path), lower('\\\\invoke-networkrelay.ps1')) OR endswith(lower(file.path), lower('\\\\invoke-ninjacopy.ps1')) OR endswith(lower(file.path), lower('\\\\invoke-oxidresolver.ps1')) OR endswith(lower(file.path), lower('\\\\invoke-p0wnedshell.ps1')) OR endswith(lower(file.path), lower('\\\\invoke-p0wnedshellx86.ps1')) OR endswith(lower(file.path), lower('\\\\invoke-paranoia.ps1')) OR endswith(lower(file.path), lower('\\\\invoke-portscan.ps1')) OR endswith(lower(file.path), lower('\\\\invoke-poshrathttp.ps1')) OR endswith(lower(file.path), lower('\\\\invoke-poshrathttps.ps1')) OR endswith(lower(file.path), lower('\\\\invoke-postexfil.ps1')) OR endswith(lower(file.path), lower('\\\\invoke-powerdump.ps1')) OR endswith(lower(file.path), lower('\\\\invoke-powershellicmp.ps1')) OR endswith(lower(file.path), lower('\\\\invoke-powershelltcp.ps1')) OR endswith(lower(file.path), lower('\\\\invoke-powershelltcponeline.ps1')) OR endswith(lower(file.path), lower('\\\\invoke-powershelltcponelinebind.ps1')) OR endswith(lower(file.path), lower('\\\\invoke-powershelludp.ps1')) OR endswith(lower(file.path), lower('\\\\invoke-powershelludponeline.ps1')) OR endswith(lower(file.path), lower('\\\\invoke-powershellwmi.ps1')) OR endswith(lower(file.path), lower('\\\\invoke-powerthief.ps1')) OR endswith(lower(file.path), lower('\\\\invoke-ppldump.ps1')) OR endswith(lower(file.path), lower('\\\\invoke-prasadhak.ps1')) OR endswith(lower(file.path), lower('\\\\invoke-psexec.ps1')) OR endswith(lower(file.path), lower('\\\\invoke-psgcat.ps1')) OR endswith(lower(file.path), lower('\\\\invoke-psgcatagent.ps1')) OR endswith(lower(file.path), lower('\\\\invoke-psinject.ps1')) OR endswith(lower(file.path), lower('\\\\invoke-psuacme.ps1')) OR endswith(lower(file.path), lower('\\\\invoke-reflectivepeinjection.ps1')) OR endswith(lower(file.path), lower('\\\\invoke-reversednslookup.ps1')) OR endswith(lower(file.path), lower('\\\\invoke-rubeus.ps1')) OR endswith(lower(file.path), lower('\\\\invoke-runas.ps1')) OR endswith(lower(file.path), lower('\\\\invoke-safetykatz.ps1')) OR endswith(lower(file.path), lower('\\\\invoke-sauroneye.ps1')) OR endswith(lower(file.path), lower('\\\\invoke-scshell.ps1')) OR endswith(lower(file.path), lower('\\\\invoke-seatbelt.ps1')) OR endswith(lower(file.path), lower('\\\\invoke-serviceabuse.ps1')) OR endswith(lower(file.path), lower('\\\\invoke-sessiongopher.ps1')) OR endswith(lower(file.path), lower('\\\\invoke-shellcode.ps1')) OR endswith(lower(file.path), lower('\\\\invoke-smbscanner.ps1')) OR endswith(lower(file.path), lower('\\\\invoke-snaffler.ps1')) OR endswith(lower(file.path), lower('\\\\invoke-spoolsample.ps1')) OR endswith(lower(file.path), lower('\\\\invoke-sshcommand.ps1')) OR endswith(lower(file.path), lower('\\\\invoke-ssidexfil.ps1')) OR endswith(lower(file.path), lower('\\\\invoke-standin.ps1')) OR endswith(lower(file.path), lower('\\\\invoke-stickynotesextract.ps1')) OR endswith(lower(file.path), lower('\\\\invoke-tater.ps1')) OR endswith(lower(file.path), lower('\\\\invoke-thunderfox.ps1')) OR endswith(lower(file.path), lower('\\\\invoke-thunderstruck.ps1')) OR endswith(lower(file.path), lower('\\\\invoke-tokenmanipulation.ps1')) OR endswith(lower(file.path), lower('\\\\invoke-tokenvator.ps1')) OR endswith(lower(file.path), lower('\\\\invoke-totalexec.ps1')) OR endswith(lower(file.path), lower('\\\\invoke-urbanbishop.ps1')) OR endswith(lower(file.path), lower('\\\\invoke-userhunter.ps1')) OR endswith(lower(file.path), lower('\\\\invoke-voicetroll.ps1')) OR endswith(lower(file.path), lower('\\\\invoke-whisker.ps1')) OR endswith(lower(file.path), lower('\\\\invoke-winenum.ps1')) OR endswith(lower(file.path), lower('\\\\invoke-winpeas.ps1')) OR endswith(lower(file.path), lower('\\\\invoke-wiretap.ps1')) OR endswith(lower(file.path), lower('\\\\invoke-wmicommand.ps1')) OR endswith(lower(file.path), lower('\\\\invoke-wscriptbypassuac.ps1')) OR endswith(lower(file.path), lower('\\\\invoke-zerologon.ps1')) OR endswith(lower(file.path), lower('\\\\keylogger.ps1')) OR endswith(lower(file.path), lower('\\\\mailraider.ps1')) OR endswith(lower(file.path), lower('\\\\new-honeyhash.ps1')) OR endswith(lower(file.path), lower('\\\\officememscraper.ps1')) OR endswith(lower(file.path), lower('\\\\offline_winpwn.ps1')) OR endswith(lower(file.path), lower('\\\\out-chm.ps1')) OR endswith(lower(file.path), lower('\\\\out-dnstxt.ps1')) OR endswith(lower(file.path), lower('\\\\out-excel.ps1')) OR endswith(lower(file.path), lower('\\\\out-hta.ps1')) OR endswith(lower(file.path), lower('\\\\out-java.ps1')) OR endswith(lower(file.path), lower('\\\\out-js.ps1')) OR endswith(lower(file.path), lower('\\\\out-minidump.ps1')) OR endswith(lower(file.path), lower('\\\\out-rundllcommand.ps1')) OR endswith(lower(file.path), lower('\\\\out-scf.ps1')) OR endswith(lower(file.path), lower('\\\\out-sct.ps1')) OR endswith(lower(file.path), lower('\\\\out-shortcut.ps1')) OR endswith(lower(file.path), lower('\\\\out-webquery.ps1')) OR endswith(lower(file.path), lower('\\\\out-word.ps1')) OR endswith(lower(file.path), lower('\\\\parse_keys.ps1')) OR endswith(lower(file.path), lower('\\\\port-scan.ps1')) OR endswith(lower(file.path), lower('\\\\powerbreach.ps1')) OR endswith(lower(file.path), lower('\\\\powercat.ps1')) OR endswith(lower(file.path), lower('\\\\powermad.ps1')) OR endswith(lower(file.path), lower('\\\\powerrunassystem.psm1')) OR endswith(lower(file.path), lower('\\\\powersharppack.ps1')) OR endswith(lower(file.path), lower('\\\\powerup.ps1')) OR endswith(lower(file.path), lower('\\\\powerupsql.ps1')) OR endswith(lower(file.path), lower('\\\\powerview.ps1')) OR endswith(lower(file.path), lower('\\\\psasyncshell.ps1')) OR endswith(lower(file.path), lower('\\\\remotehashretrieval.ps1')) OR endswith(lower(file.path), lower('\\\\remove-persistence.ps1')) OR endswith(lower(file.path), lower('\\\\remove-poshrat.ps1')) OR endswith(lower(file.path), lower('\\\\remove-update.ps1')) OR endswith(lower(file.path), lower('\\\\run-exeonremote.ps1')) OR endswith(lower(file.path), lower('\\\\schtasks-backdoor.ps1')) OR endswith(lower(file.path), lower('\\\\set-dcshadowpermissions.ps1')) OR endswith(lower(file.path), lower('\\\\set-macattribute.ps1')) OR endswith(lower(file.path), lower('\\\\set-remotepsremoting.ps1')) OR endswith(lower(file.path), lower('\\\\set-remotewmi.ps1')) OR endswith(lower(file.path), lower('\\\\set-wallpaper.ps1')) OR endswith(lower(file.path), lower('\\\\show-targetscreen.ps1')) OR endswith(lower(file.path), lower('\\\\speak.ps1')) OR endswith(lower(file.path), lower('\\\\start-captureserver.ps1')) OR endswith(lower(file.path), lower('\\\\start-webcamrecorder.ps1')) OR endswith(lower(file.path), lower('\\\\stringtobase64.ps1')) OR endswith(lower(file.path), lower('\\\\texttoexe.ps1')) OR endswith(lower(file.path), lower('\\\\volumeshadowcopytools.ps1')) OR endswith(lower(file.path), lower('\\\\winpwn.ps1')) OR endswith(lower(file.path), lower('\\\\wsuspendu.ps1')) OR contains(lower(file.path), lower('invoke-sharp')) AND endswith(lower(file.path), lower('.ps1'))))"
      }
    },
    "output": {
      "summary": "Detects the creation of known offensive powershell scripts used for exploitation",
      "defaultContext": true
    },
    "metadata": {
      "version": 1.0,
      "severity": "High",
      "fidelity": "Investigative",
      "objective": "False positive: Unknown References: https://github.com/PowerShellMafia/PowerSploit, https://github.com/NetSPI/PowerUpSQL, https://github.com/CsEnox/EventViewer-UACBypass, https://web.archive.org/web/20210511204621/https://github.com/AlsidOfficial/WSUSpendu, https://github.com/nettitude/Invoke-PowerThIEf, https://github.com/S3cur3Th1sSh1t/WinPwn, https://github.com/S3cur3Th1sSh1t/PowerSharpPack/tree/master/PowerSharpBinaries, https://github.com/BC-SECURITY/Invoke-ZeroLogon/blob/111d17c7fec486d9bb23387e2e828b09a26075e4/Invoke-ZeroLogon.ps1, https://github.com/xorrior/RandomPS-Scripts/blob/848c919bfce4e2d67b626cbcf4404341cfe3d3b6/Get-DXWebcamVideo.ps1, https://github.com/rvrsh3ll/Misc-Powershell-Scripts/blob/6f23bb41f9675d7e2d32bacccff75e931ae00554/OfficeMemScraper.ps1, https://github.com/dafthack/DomainPasswordSpray/blob/b13d64a5834694aa73fd2aea9911a83027c465a7/DomainPasswordSpray.ps1, https://unit42.paloaltonetworks.com/threat-assessment-black-basta-ransomware/, https://research.nccgroup.com/2022/06/06/shining-the-light-on-black-basta/, https://github.com/HarmJ0y/DAMP, https://github.com/samratashok/nishang, https://github.com/DarkCoderSc/PowerRunAsSystem/, https://github.com/besimorhino/powercat, https://github.com/Kevin-Robertson/Powermad, https://github.com/adrecon/ADRecon, https://github.com/adrecon/AzureADRecon",
      "mitre": [
        {
          "taxonomy": "MITRE ATT&CK",
          "tactic": "Execution",
          "techniqueId": "T1059",
          "subTechniqueId": "001"
        }
      ]
    },
    "computeMode": "high"
  },
  "apiVersion": "v1",
  "kind": "Rule"
}