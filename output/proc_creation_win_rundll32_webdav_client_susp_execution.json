{
  "metadata": {
    "name": "Suspicious WebDav Client Execution Via Rundll32.EXE",
    "comment": "Detects \"svchost.exe\" spawning \"rundll32.exe\" with command arguments like C:\\windows\\system32\\davclnt.dll,DavSetCookie. This could be an indicator of exfiltration or use of WebDav to launch code (hosted on WebDav Server) or potentially a sign of exploitation of CVE-2023-23397",
    "annotations": {
      "source": "sigma",
      "category": "process_creation",
      "product": "windows",
      "sigma_status": "test"
    }
  },
  "spec": {
    "schedule": {
      "atLeastEvery": "12h",
      "enabled": false
    },
    "input": {
      "batch": {
        "sql": "SELECT * FROM process_activity WHERE time BETWEEN CURRENT_TIMESTAMP() - INTERVAL 24 HOUR AND CURRENT_TIMESTAMP() AND (lower(activity_id) = lower('1') AND endswith(lower(process.parent_process.name), lower('\\\\svchost.exe')) AND contains(lower(process.parent_process.cmd_line), lower('-s webclient')) AND endswith(lower(process.name), lower('\\\\rundll32.exe')) AND contains(lower(process.cmd_line), lower('c:\\\\windows\\\\system32\\\\davclnt.dll,davsetcookie')) AND process.cmd_line rlike '://\\\\d\\{1,3\\}\\\\.\\\\d\\{1,3\\}\\\\.\\\\d\\{1,3\\}\\\\.\\\\d\\{1,3\\}' AND NOT (contains(lower(process.cmd_line), lower('://10.')) OR contains(lower(process.cmd_line), lower('://192.168.')) OR contains(lower(process.cmd_line), lower('://172.16.')) OR contains(lower(process.cmd_line), lower('://172.17.')) OR contains(lower(process.cmd_line), lower('://172.18.')) OR contains(lower(process.cmd_line), lower('://172.19.')) OR contains(lower(process.cmd_line), lower('://172.20.')) OR contains(lower(process.cmd_line), lower('://172.21.')) OR contains(lower(process.cmd_line), lower('://172.22.')) OR contains(lower(process.cmd_line), lower('://172.23.')) OR contains(lower(process.cmd_line), lower('://172.24.')) OR contains(lower(process.cmd_line), lower('://172.25.')) OR contains(lower(process.cmd_line), lower('://172.26.')) OR contains(lower(process.cmd_line), lower('://172.27.')) OR contains(lower(process.cmd_line), lower('://172.28.')) OR contains(lower(process.cmd_line), lower('://172.29.')) OR contains(lower(process.cmd_line), lower('://172.30.')) OR contains(lower(process.cmd_line), lower('://172.31.')) OR contains(lower(process.cmd_line), lower('://127.')) OR contains(lower(process.cmd_line), lower('://169.254.'))))"
      }
    },
    "output": {
      "summary": "Detects \"svchost.exe\" spawning \"rundll32.exe\" with command arguments like C:\\windows\\system32\\davclnt.dll,DavSetCookie. This could be an indicator of exfiltration or use of WebDav to launch code (hosted on WebDav Server) or potentially a sign of exploitation of CVE-2023-23397",
      "defaultContext": true
    },
    "metadata": {
      "version": 1.0,
      "severity": "High",
      "fidelity": "Investigative",
      "objective": "False positive: Unknown References: https://twitter.com/aceresponder/status/1636116096506818562, https://www.mdsec.co.uk/2023/03/exploiting-cve-2023-23397-microsoft-outlook-elevation-of-privilege-vulnerability/, https://www.pwndefend.com/2023/03/15/the-long-game-persistent-hash-theft/, https://www.microsoft.com/en-us/security/blog/wp-content/uploads/2023/03/Figure-7-sample-webdav-process-create-event.png, https://www.microsoft.com/en-us/security/blog/2023/03/24/guidance-for-investigating-attacks-using-cve-2023-23397/",
      "mitre": [
        {
          "taxonomy": "MITRE ATT&CK",
          "tactic": "Exfiltration",
          "techniqueId": "T1048",
          "subTechniqueId": "003"
        }
      ]
    },
    "computeMode": "high"
  },
  "apiVersion": "v1",
  "kind": "Rule"
}