{
  "metadata": {
    "name": "VMToolsd Suspicious Child Process",
    "comment": "Detects suspicious child process creations of VMware Tools process which may indicate persistence setup",
    "annotations": {
      "source": "sigma",
      "category": "process_creation",
      "product": "windows",
      "sigma_status": "test"
    }
  },
  "spec": {
    "schedule": {
      "atLeastEvery": "12h",
      "enabled": false
    },
    "input": {
      "batch": {
        "sql": "SELECT * FROM process_activity WHERE time BETWEEN CURRENT_TIMESTAMP() - INTERVAL 24 HOUR AND CURRENT_TIMESTAMP() AND (lower(activity_id) = lower('1') AND endswith(lower(process.parent_process.name), lower('\\\\vmtoolsd.exe')) AND (endswith(lower(process.name), lower('\\\\cmd.exe')) OR endswith(lower(process.name), lower('\\\\cscript.exe')) OR endswith(lower(process.name), lower('\\\\mshta.exe')) OR endswith(lower(process.name), lower('\\\\powershell.exe')) OR endswith(lower(process.name), lower('\\\\pwsh.exe')) OR endswith(lower(process.name), lower('\\\\regsvr32.exe')) OR endswith(lower(process.name), lower('\\\\rundll32.exe')) OR endswith(lower(process.name), lower('\\\\wscript.exe'))) AND (lower(LOWER(process.file.name)) in ('cmd\\.exe', 'cscript\\.exe', 'mshta\\.exe', 'powershell\\.exe', 'pwsh\\.dll', 'regsvr32\\.exe', 'rundll32\\.exe', 'wscript\\.exe')) AND NOT (endswith(lower(process.name), lower('\\\\cmd.exe')) AND (contains(lower(process.cmd_line), lower('\\\\vmware\\\\vmware tools\\\\poweron-vm-default.bat')) OR contains(lower(process.cmd_line), lower('\\\\vmware\\\\vmware tools\\\\poweroff-vm-default.bat')) OR contains(lower(process.cmd_line), lower('\\\\vmware\\\\vmware tools\\\\resume-vm-default.bat')) OR contains(lower(process.cmd_line), lower('\\\\vmware\\\\vmware tools\\\\suspend-vm-default.bat'))) OR endswith(lower(process.name), lower('\\\\cmd.exe')) AND lower(process.cmd_line) = lower('') OR endswith(lower(process.name), lower('\\\\cmd.exe')) AND process.cmd_line is null))"
      }
    },
    "output": {
      "summary": "Detects suspicious child process creations of VMware Tools process which may indicate persistence setup",
      "defaultContext": true
    },
    "metadata": {
      "version": 1.0,
      "severity": "High",
      "fidelity": "Investigative",
      "objective": "False positive: Legitimate use by VM administrator References: https://bohops.com/2021/10/08/analyzing-and-detecting-a-vmtools-persistence-technique/, https://user-images.githubusercontent.com/61026070/136518004-b68cce7d-f9b8-4e9a-9b7b-53b1568a9a94.png, https://github.com/vmware/open-vm-tools/blob/master/open-vm-tools/tools.conf",
      "mitre": [
        {
          "taxonomy": "MITRE ATT&CK",
          "tactic": "Execution",
          "techniqueId": "T1059"
        }
      ]
    },
    "computeMode": "high"
  },
  "apiVersion": "v1",
  "kind": "Rule"
}