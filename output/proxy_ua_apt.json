{
  "metadata": {
    "name": "APT User Agent",
    "comment": "Detects suspicious user agent strings used in APT malware in proxy logs",
    "annotations": {
      "source": "sigma",
      "category": "proxy",
      "sigma_status": "test"
    }
  },
  "spec": {
    "schedule": {
      "atLeastEvery": "12h",
      "enabled": false
    },
    "input": {
      "batch": {
        "sql": "SELECT * FROM http_activity WHERE time BETWEEN CURRENT_TIMESTAMP() - INTERVAL 24 HOUR AND CURRENT_TIMESTAMP() AND (lower(http_request.user_agent) = lower('sjzj (compatible; msie 6.0; win32)') OR lower(http_request.user_agent) = lower('mozilla/5.0 (windows nt 6.; wow64; rv:20.0) gecko/20100101 firefox/20.0') OR lower(http_request.user_agent) = lower('user-agent: mozilla/4.0 (compatible; msie 8.0; windows nt 6.1; trident/4.0; slcc') OR lower(http_request.user_agent) = lower('mozilla/4.0 (compatible; msie 7.4; win32;32-bit)') OR lower(http_request.user_agent) = lower('webclient') OR lower(http_request.user_agent) = lower('mozilla/5.0 (windows; u; windows nt 5.1; zh-en; rv:1.7.12) gecko/200') OR lower(http_request.user_agent) = lower('mozilla/4.0 (compatible; msi 6.0;') OR lower(http_request.user_agent) = lower('mozilla/5.0 (windows nt 6.3; wow64; rv:28.0) gecko/20100101 firefox/28.0') OR lower(http_request.user_agent) = lower('mozilla/5.0 (windows nt 6.2; wow64; rv:20.0) gecko/20100101 firefox/') OR lower(http_request.user_agent) = lower('mozilla/5.0 (windows nt 6.; wow64; rv:20.0) gecko/20100101 firefox/2') OR lower(http_request.user_agent) = lower('mozilla/4.0') OR lower(http_request.user_agent) = lower('netscape') OR lower(http_request.user_agent) = lower('mozilla/5.0 (windows; u; windows nt 5.1; zh-en; rv:1.7.12) gecko/20100719 firefox/1.0.7') OR lower(http_request.user_agent) = lower('mozilla/5.0 (windows; u; windows nt 5.1; en-us; rv:1.9.2.13) firefox/3.6.13 gtb7.1') OR lower(http_request.user_agent) = lower('mozilla/5.0 (compatible; msie 9.0; windows nt 6.1; wow64; trident/5.0)') OR lower(http_request.user_agent) = lower('mozilla/4.0 (compatible; msie 8.0; windows nt 6.1; wow64; trident/4.0; slcc2; .netclr 2.0.50727)') OR lower(http_request.user_agent) = lower('mozilla/4.0 (compatible; msie 8.0; windows nt 6.0; sv1)') OR lower(http_request.user_agent) = lower('mozilla/4.0 (compatible; msie 11.0; windows nt 6.1; sv1)') OR lower(http_request.user_agent) = lower('mozilla/4.0 (compatible; msie 8.0; win32)') OR lower(http_request.user_agent) = lower('mozilla v5.1 (windows nt 6.1; rv:6.0.1) gecko/20100101 firefox/6.0.1') OR lower(http_request.user_agent) = lower('mozilla/6.1 (compatible; msie 9.0; windows nt 5.3; trident/5.0)') OR lower(http_request.user_agent) = lower('mozilla/4.0 (compatible; msie 6.0; windows nt 5.1; sv1; .net clr 1.1.4322; .net clr 2.0.50727; .net clr 3.0.04506.30; .net clr 3.0.04506.648; infopath.1)') OR lower(http_request.user_agent) = lower('mozilla/5.0 (windows nt 6.1; wow64) winhttp/1.6.3.8 (winhttp/5.1) like gecko') OR startswith(lower(http_request.user_agent), lower('mozilla v5.1 ')) OR lower(http_request.user_agent) = lower('msie 8.0') OR lower(http_request.user_agent) = lower('mozilla/4.0 (compatible; msie 7.0; windows nt 6.1; slcc2; .net clr 2.0.50727; .net clr 3.5.30729; .net clr 3.0.30729; media center pc 6.0; .net4.0c; .net4.0e; infopath.2)') OR lower(http_request.user_agent) = lower('mozilla/4.0 (compatible; rms)') OR lower(http_request.user_agent) = lower('mozilla/4.0 (compatible; msie 6.0; dyngate)') OR lower(http_request.user_agent) = lower('o/9.27 (w; u; z)') OR startswith(lower(http_request.user_agent), lower('mozilla/5.0 (compatible; msie 9.0; windows nt 6.0; trident/5.0;  trident/5.0')) OR startswith(lower(http_request.user_agent), lower('mozilla/5.0 (windows nt 9; ')) OR lower(http_request.user_agent) = lower('hots scot') OR lower(http_request.user_agent) = lower('mozilla/5.0 (compatible; msie 10.0; windows nt)') OR lower(http_request.user_agent) = lower('mozilla/5.0 (windows nt 6.1; wow64) chrome/28.0.1500.95 safari/537.36') OR lower(http_request.user_agent) = lower('mozilla/5.0 (windows nt 6.2; win32; rv:47.0)') OR lower(http_request.user_agent) = lower('mozilla/4.0 (compatible; msie 6.0; windows nt 5.1;sv1;') OR lower(http_request.user_agent) = lower('mozilla/5.0 (x11; linux i686; rv:22.0) firefox/22.0') OR lower(http_request.user_agent) = lower('mozilla/5.0 chrome/72.0.3626.109 safari/537.36') OR lower(http_request.user_agent) = lower('mozilla/5.0 (windows nt 10.0; win64; x64; rv:fts_06) gecko/22.36.35.06 firefox/2.0') OR lower(http_request.user_agent) = lower('mozilla/5.0 (windows nt 10.0; win64; x64) applewebkit/537.36 (khtml, like gecko) chrome/102.0.5005.63 safari/537.36 edg/100.0.1185.39') OR lower(http_request.user_agent) = lower('mozilla/4.0 (compatible; msie 7.0; windows nt 6.1; wow64; trident/4.0; slcc2; .net clr 2.0.50727; .net clr 3.5.30729; .net clr 3.0.30729; infopath.3; .net4.0c; .net4.0e)') OR lower(http_request.user_agent) = lower('mozilla/4.0 (compatible; msie 9.0; windows nt 10.0; .net4.0c; .net4.0e; tablet pc 2.0)') OR lower(http_request.user_agent) = lower('mozilla/5.0 (windows nt 10.0; win64; x64) applewebkit/537.36 (khtml, like gecko) chrome/42.0.2311.135 safari/537.36 edge/12.246001'))"
      }
    },
    "output": {
      "summary": "Detects suspicious user agent strings used in APT malware in proxy logs",
      "defaultContext": true
    },
    "metadata": {
      "version": 1.0,
      "severity": "High",
      "fidelity": "Investigative",
      "objective": "Examine fields: ClientIP, http_request.url, http_request.user_agent False positive: Old browsers Reference: Internal Research",
      "mitre": [
        {
          "taxonomy": "MITRE ATT&CK",
          "tactic": "Command-And-Control",
          "techniqueId": "T1071",
          "subTechniqueId": "001"
        }
      ]
    },
    "computeMode": "high"
  },
  "apiVersion": "v1",
  "kind": "Rule"
}