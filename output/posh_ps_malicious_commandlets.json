{
  "metadata": {
    "name": "Malicious PowerShell Commandlets - ScriptBlock",
    "comment": "Detects Commandlet names from well-known PowerShell exploitation frameworks",
    "annotations": {
      "source": "sigma",
      "category": "ps_script",
      "product": "windows",
      "sigma_status": "test"
    }
  },
  "spec": {
    "schedule": {
      "atLeastEvery": "12h",
      "enabled": false
    },
    "input": {
      "batch": {
        "sql": "SELECT * FROM script_activity WHERE time BETWEEN CURRENT_TIMESTAMP() - INTERVAL 24 HOUR AND CURRENT_TIMESTAMP() AND (lower(activity_id) = lower('1') AND (contains(lower(script.script_content.value), lower('add-exfiltration')) OR contains(lower(script.script_content.value), lower('add-persistence')) OR contains(lower(script.script_content.value), lower('add-regbackdoor')) OR contains(lower(script.script_content.value), lower('add-remoteregbackdoor')) OR contains(lower(script.script_content.value), lower('add-scrnsavebackdoor')) OR contains(lower(script.script_content.value), lower('convertto-rc4bytestream')) OR contains(lower(script.script_content.value), lower('decrypt-hash')) OR contains(lower(script.script_content.value), lower('disable-adidnsnode')) OR contains(lower(script.script_content.value), lower('do-exfiltration')) OR contains(lower(script.script_content.value), lower('enable-adidnsnode')) OR contains(lower(script.script_content.value), lower('enabled-duplicatetoken')) OR contains(lower(script.script_content.value), lower('exploit-jboss')) OR contains(lower(script.script_content.value), lower('export-adrcsv')) OR contains(lower(script.script_content.value), lower('export-adrexcel')) OR contains(lower(script.script_content.value), lower('export-adrhtml')) OR contains(lower(script.script_content.value), lower('export-adrjson')) OR contains(lower(script.script_content.value), lower('export-adrxml')) OR contains(lower(script.script_content.value), lower('find-fruit')) OR contains(lower(script.script_content.value), lower('find-gpolocation')) OR contains(lower(script.script_content.value), lower('find-trusteddocuments')) OR contains(lower(script.script_content.value), lower('get-adidnsnodeattribute')) OR contains(lower(script.script_content.value), lower('get-adidnsnodeowner')) OR contains(lower(script.script_content.value), lower('get-adidnsnodetombstoned')) OR contains(lower(script.script_content.value), lower('get-adidnspermission')) OR contains(lower(script.script_content.value), lower('get-adidnszone')) OR contains(lower(script.script_content.value), lower('get-chromedump')) OR contains(lower(script.script_content.value), lower('get-clipboardcontents')) OR contains(lower(script.script_content.value), lower('get-foxdump')) OR contains(lower(script.script_content.value), lower('get-gpppassword')) OR contains(lower(script.script_content.value), lower('get-indexeditem')) OR contains(lower(script.script_content.value), lower('get-kerberosaeskey')) OR contains(lower(script.script_content.value), lower('get-keystrokes')) OR contains(lower(script.script_content.value), lower('get-lsasecret')) OR contains(lower(script.script_content.value), lower('get-passhashes')) OR contains(lower(script.script_content.value), lower('get-regalwaysinstallelevated')) OR contains(lower(script.script_content.value), lower('get-regautologon')) OR contains(lower(script.script_content.value), lower('get-remotebootkey')) OR contains(lower(script.script_content.value), lower('get-remotecachedcredential')) OR contains(lower(script.script_content.value), lower('get-remotelocalaccounthash')) OR contains(lower(script.script_content.value), lower('get-remotelsakey')) OR contains(lower(script.script_content.value), lower('get-remotemachineaccounthash')) OR contains(lower(script.script_content.value), lower('get-remotenlkmkey')) OR contains(lower(script.script_content.value), lower('get-rickastley')) OR contains(lower(script.script_content.value), lower('get-securitypackages')) OR contains(lower(script.script_content.value), lower('get-servicefilepermission')) OR contains(lower(script.script_content.value), lower('get-servicepermission')) OR contains(lower(script.script_content.value), lower('get-serviceunquoted')) OR contains(lower(script.script_content.value), lower('get-sitelistpassword')) OR contains(lower(script.script_content.value), lower('get-system')) OR contains(lower(script.script_content.value), lower('get-timedscreenshot')) OR contains(lower(script.script_content.value), lower('get-unattendedinstallfile')) OR contains(lower(script.script_content.value), lower('get-unconstrained')) OR contains(lower(script.script_content.value), lower('get-usbkeystrokes')) OR contains(lower(script.script_content.value), lower('get-vaultcredential')) OR contains(lower(script.script_content.value), lower('get-vulnautorun')) OR contains(lower(script.script_content.value), lower('get-vulnschtask')) OR contains(lower(script.script_content.value), lower('grant-adidnspermission')) OR contains(lower(script.script_content.value), lower('gupt-backdoor')) OR contains(lower(script.script_content.value), lower('invoke-aclscanner')) OR contains(lower(script.script_content.value), lower('invoke-adrecon')) OR contains(lower(script.script_content.value), lower('invoke-adsbackdoor')) OR contains(lower(script.script_content.value), lower('invoke-agentsmith')) OR contains(lower(script.script_content.value), lower('invoke-allchecks')) OR contains(lower(script.script_content.value), lower('invoke-arpscan')) OR contains(lower(script.script_content.value), lower('invoke-azurehound')) OR contains(lower(script.script_content.value), lower('invoke-backdoorlnk')) OR contains(lower(script.script_content.value), lower('invoke-badpotato')) OR contains(lower(script.script_content.value), lower('invoke-bettersafetykatz')) OR contains(lower(script.script_content.value), lower('invoke-bypassuac')) OR contains(lower(script.script_content.value), lower('invoke-carbuncle')) OR contains(lower(script.script_content.value), lower('invoke-certify')) OR contains(lower(script.script_content.value), lower('invoke-conptyshell')) OR contains(lower(script.script_content.value), lower('invoke-credentialinjection')) OR contains(lower(script.script_content.value), lower('invoke-daft')) OR contains(lower(script.script_content.value), lower('invoke-dcsync')) OR contains(lower(script.script_content.value), lower('invoke-dinvokekatz')) OR contains(lower(script.script_content.value), lower('invoke-dllinjection')) OR contains(lower(script.script_content.value), lower('invoke-dnsupdate')) OR contains(lower(script.script_content.value), lower('invoke-domainpasswordspray')) OR contains(lower(script.script_content.value), lower('invoke-downgradeaccount')) OR contains(lower(script.script_content.value), lower('invoke-egresscheck')) OR contains(lower(script.script_content.value), lower('invoke-eyewitness')) OR contains(lower(script.script_content.value), lower('invoke-fakelogonscreen')) OR contains(lower(script.script_content.value), lower('invoke-farmer')) OR contains(lower(script.script_content.value), lower('invoke-get-rbcd-threaded')) OR contains(lower(script.script_content.value), lower('invoke-gopher')) OR contains(lower(script.script_content.value), lower('invoke-grouper')) OR contains(lower(script.script_content.value), lower('invoke-handlekatz')) OR contains(lower(script.script_content.value), lower('invoke-impersonatedprocess')) OR contains(lower(script.script_content.value), lower('invoke-impersonatesystem')) OR contains(lower(script.script_content.value), lower('invoke-interactivesystempowershell')) OR contains(lower(script.script_content.value), lower('invoke-internalmonologue')) OR contains(lower(script.script_content.value), lower('invoke-inveigh')) OR contains(lower(script.script_content.value), lower('invoke-inveighrelay')) OR contains(lower(script.script_content.value), lower('invoke-krbrelay')) OR contains(lower(script.script_content.value), lower('invoke-ldapsigncheck')) OR contains(lower(script.script_content.value), lower('invoke-lockless')) OR contains(lower(script.script_content.value), lower('invoke-malsccm')) OR contains(lower(script.script_content.value), lower('invoke-mimikatz')) OR contains(lower(script.script_content.value), lower('invoke-mimikittenz')) OR contains(lower(script.script_content.value), lower('invoke-mitm6')) OR contains(lower(script.script_content.value), lower('invoke-nanodump')) OR contains(lower(script.script_content.value), lower('invoke-netripper')) OR contains(lower(script.script_content.value), lower('invoke-nightmare')) OR contains(lower(script.script_content.value), lower('invoke-ninjacopy')) OR contains(lower(script.script_content.value), lower('invoke-officescrape')) OR contains(lower(script.script_content.value), lower('invoke-oxidresolver')) OR contains(lower(script.script_content.value), lower('invoke-p0wnedshell')) OR contains(lower(script.script_content.value), lower('invoke-paranoia')) OR contains(lower(script.script_content.value), lower('invoke-portscan')) OR contains(lower(script.script_content.value), lower('invoke-poshrathttp')) OR contains(lower(script.script_content.value), lower('invoke-postexfil')) OR contains(lower(script.script_content.value), lower('invoke-powerdump')) OR contains(lower(script.script_content.value), lower('invoke-powershelltcp')) OR contains(lower(script.script_content.value), lower('invoke-powershellwmi')) OR contains(lower(script.script_content.value), lower('invoke-ppldump')) OR contains(lower(script.script_content.value), lower('invoke-psexec')) OR contains(lower(script.script_content.value), lower('invoke-psinject')) OR contains(lower(script.script_content.value), lower('invoke-psuacme')) OR contains(lower(script.script_content.value), lower('invoke-reflectivepeinjection')) OR contains(lower(script.script_content.value), lower('invoke-reversednslookup')) OR contains(lower(script.script_content.value), lower('invoke-rubeus')) OR contains(lower(script.script_content.value), lower('invoke-runas')) OR contains(lower(script.script_content.value), lower('invoke-safetykatz')) OR contains(lower(script.script_content.value), lower('invoke-sauroneye')) OR contains(lower(script.script_content.value), lower('invoke-scshell')) OR contains(lower(script.script_content.value), lower('invoke-seatbelt')) OR contains(lower(script.script_content.value), lower('invoke-serviceabuse')) OR contains(lower(script.script_content.value), lower('invoke-shadowspray')) OR contains(lower(script.script_content.value), lower('invoke-sharp')) OR contains(lower(script.script_content.value), lower('invoke-shellcode')) OR contains(lower(script.script_content.value), lower('invoke-smbscanner')) OR contains(lower(script.script_content.value), lower('invoke-snaffler')) OR contains(lower(script.script_content.value), lower('invoke-spoolsample')) OR contains(lower(script.script_content.value), lower('invoke-spraysinglepassword')) OR contains(lower(script.script_content.value), lower('invoke-sshcommand')) OR contains(lower(script.script_content.value), lower('invoke-standin')) OR contains(lower(script.script_content.value), lower('invoke-stickynotesextract')) OR contains(lower(script.script_content.value), lower('invoke-systemcommand')) OR contains(lower(script.script_content.value), lower('invoke-tasksbackdoor')) OR contains(lower(script.script_content.value), lower('invoke-tater')) OR contains(lower(script.script_content.value), lower('invoke-thunderfox')) OR contains(lower(script.script_content.value), lower('invoke-thunderstruck')) OR contains(lower(script.script_content.value), lower('invoke-tokenmanipulation')) OR contains(lower(script.script_content.value), lower('invoke-tokenvator')) OR contains(lower(script.script_content.value), lower('invoke-totalexec')) OR contains(lower(script.script_content.value), lower('invoke-urbanbishop')) OR contains(lower(script.script_content.value), lower('invoke-userhunter')) OR contains(lower(script.script_content.value), lower('invoke-voicetroll')) OR contains(lower(script.script_content.value), lower('invoke-whisker')) OR contains(lower(script.script_content.value), lower('invoke-winenum')) OR contains(lower(script.script_content.value), lower('invoke-winpeas')) OR contains(lower(script.script_content.value), lower('invoke-wiretap')) OR contains(lower(script.script_content.value), lower('invoke-wmicommand')) OR contains(lower(script.script_content.value), lower('invoke-wmiexec')) OR contains(lower(script.script_content.value), lower('invoke-wscriptbypassuac')) OR contains(lower(script.script_content.value), lower('invoke-zerologon')) OR contains(lower(script.script_content.value), lower('mailraider')) OR contains(lower(script.script_content.value), lower('new-adidnsnode')) OR contains(lower(script.script_content.value), lower('new-honeyhash')) OR contains(lower(script.script_content.value), lower('new-inmemorymodule')) OR contains(lower(script.script_content.value), lower('new-soaserialnumberarray')) OR contains(lower(script.script_content.value), lower('out-minidump')) OR contains(lower(script.script_content.value), lower('powerbreach')) OR contains(lower(script.script_content.value), lower('powercat ')) OR contains(lower(script.script_content.value), lower('powerup')) OR contains(lower(script.script_content.value), lower('powerview')) OR contains(lower(script.script_content.value), lower('remove-adidnsnode')) OR contains(lower(script.script_content.value), lower('remove-update')) OR contains(lower(script.script_content.value), lower('rename-adidnsnode')) OR contains(lower(script.script_content.value), lower('revoke-adidnspermission')) OR contains(lower(script.script_content.value), lower('set-adidnsnode')) OR contains(lower(script.script_content.value), lower('show-targetscreen')) OR contains(lower(script.script_content.value), lower('start-captureserver')) OR contains(lower(script.script_content.value), lower('start-dnscat2')) OR contains(lower(script.script_content.value), lower('start-webcamrecorder')) OR contains(lower(script.script_content.value), lower('volumeshadowcopytools'))) AND NOT (contains(lower(script.script_content.value), lower('get-systemdriveinfo')) OR contains(lower(script.script_content.value), lower('c:\\\\programdata\\\\amazon\\\\ec2-windows\\\\launch\\\\module\\\\'))))"
      }
    },
    "output": {
      "summary": "Detects Commandlet names from well-known PowerShell exploitation frameworks",
      "defaultContext": true
    },
    "metadata": {
      "version": 1.0,
      "severity": "High",
      "fidelity": "Investigative",
      "objective": "False positive: Unknown References: https://adsecurity.org/?p=2921, https://github.com/S3cur3Th1sSh1t/PowerSharpPack/tree/master/PowerSharpBinaries, https://github.com/BC-SECURITY/Invoke-ZeroLogon/blob/111d17c7fec486d9bb23387e2e828b09a26075e4/Invoke-ZeroLogon.ps1, https://github.com/xorrior/RandomPS-Scripts/blob/848c919bfce4e2d67b626cbcf4404341cfe3d3b6/Get-DXWebcamVideo.ps1, https://github.com/rvrsh3ll/Misc-Powershell-Scripts/blob/6f23bb41f9675d7e2d32bacccff75e931ae00554/OfficeMemScraper.ps1, https://github.com/dafthack/DomainPasswordSpray/blob/b13d64a5834694aa73fd2aea9911a83027c465a7/DomainPasswordSpray.ps1, https://unit42.paloaltonetworks.com/threat-assessment-black-basta-ransomware/, https://research.nccgroup.com/2022/06/06/shining-the-light-on-black-basta/, https://github.com/calebstewart/CVE-2021-1675, https://github.com/BloodHoundAD/BloodHound/blob/0927441f67161cc6dc08a53c63ceb8e333f55874/Collectors/AzureHound.ps1, https://bloodhound.readthedocs.io/en/latest/data-collection/azurehound.html, https://github.com/HarmJ0y/DAMP, https://github.com/samratashok/nishang, https://github.com/DarkCoderSc/PowerRunAsSystem/, https://github.com/besimorhino/powercat, https://github.com/Kevin-Robertson/Powermad, https://github.com/adrecon/ADRecon, https://github.com/adrecon/AzureADRecon",
      "mitre": [
        {
          "taxonomy": "MITRE ATT&CK",
          "tactic": "Execution",
          "techniqueId": "T1482"
        },
        {
          "taxonomy": "MITRE ATT&CK",
          "tactic": "Execution",
          "techniqueId": "T1087"
        },
        {
          "taxonomy": "MITRE ATT&CK",
          "tactic": "Execution",
          "techniqueId": "T1059",
          "subTechniqueId": "001"
        },
        {
          "taxonomy": "MITRE ATT&CK",
          "tactic": "Execution",
          "techniqueId": "T1069",
          "subTechniqueId": "002"
        },
        {
          "taxonomy": "MITRE ATT&CK",
          "tactic": "Execution",
          "techniqueId": "T1069"
        }
      ]
    },
    "computeMode": "high"
  },
  "apiVersion": "v1",
  "kind": "Rule"
}