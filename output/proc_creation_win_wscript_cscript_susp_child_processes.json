{
  "metadata": {
    "name": "Cscript/Wscript Potentially Suspicious Child Process",
    "comment": "Detects potentially suspicious child processes of Wscript/Cscript. These include processes such as rundll32 with uncommon exports or PowerShell spawning rundll32 or regsvr32. Malware such as Pikabot and Qakbot were seen using similar techniques as well as many others.",
    "annotations": {
      "source": "sigma",
      "category": "process_creation",
      "product": "windows",
      "sigma_status": "test"
    }
  },
  "spec": {
    "schedule": {
      "atLeastEvery": "15m",
      "enabled": true
    },
    "input": {
      "batch": {
        "sql": "SELECT * FROM process_activity WHERE time BETWEEN CURRENT_TIMESTAMP() - INTERVAL 24 HOUR AND CURRENT_TIMESTAMP() AND (lower(activity_id) = lower('1') AND (endswith(lower(process.parent_process.name), lower('\\\\wscript.exe')) OR endswith(lower(process.parent_process.name), lower('\\\\cscript.exe'))) AND (endswith(lower(process.name), lower('\\\\rundll32.exe')) OR (endswith(lower(process.name), lower('\\\\cmd.exe')) OR endswith(lower(process.name), lower('\\\\powershell.exe')) OR endswith(lower(process.name), lower('\\\\pwsh.exe'))) AND (contains(lower(process.cmd_line), lower('mshta')) AND contains(lower(process.cmd_line), lower('http')) OR contains(lower(process.cmd_line), lower('rundll32')) OR contains(lower(process.cmd_line), lower('regsvr32')) OR contains(lower(process.cmd_line), lower('msiexec')))) AND NOT (endswith(lower(process.name), lower('\\\\rundll32.exe')) AND (contains(lower(process.cmd_line), lower('updateperusersystemparameters')) OR contains(lower(process.cmd_line), lower('printuientry')) OR contains(lower(process.cmd_line), lower('clearmytracksbyprocess')))))"
      }
    },
    "output": {
      "summary": "Detects potentially suspicious child processes of Wscript/Cscript. These include processes such as rundll32 with uncommon exports or PowerShell spawning rundll32 or regsvr32. Malware such as Pikabot and Qakbot were seen using similar techniques as well as many others.",
      "defaultContext": true
    },
    "metadata": {
      "version": 1.0,
      "severity": "Medium",
      "fidelity": "Investigative",
      "objective": "False positive: Some false positives might occur with admin or third party software scripts. Investigate and apply additional filters accordingly. References: Internal Research, https://github.com/pr0xylife/Pikabot/blob/main/Pikabot_30.10.2023.txt, https://github.com/pr0xylife/Pikabot/blob/main/Pikabot_22.12.2023.txt",
      "mitre": [
        {
          "taxonomy": "MITRE ATT&CK",
          "tactic": "Execution"
        }
      ]
    },
    "computeMode": "high"
  },
  "apiVersion": "v1",
  "kind": "Rule"
}