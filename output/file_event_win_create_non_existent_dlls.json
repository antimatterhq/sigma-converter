{
  "metadata": {
    "name": "Creation Of Non-Existent System DLL",
    "comment": "Detects the creation of system DLLs that are usually not present on the system (or at least not in system directories). Usually this technique is used to achieve DLL hijacking.",
    "annotations": {
      "source": "sigma",
      "category": "file_event",
      "product": "windows",
      "sigma_status": "test"
    }
  },
  "spec": {
    "schedule": {
      "atLeastEvery": "15m",
      "enabled": true
    },
    "input": {
      "batch": {
        "sql": "SELECT * FROM file_activity WHERE time BETWEEN CURRENT_TIMESTAMP() - INTERVAL 24 HOUR AND CURRENT_TIMESTAMP() AND (lower(activity_id) = lower('1') AND (endswith(lower(file.path), lower(':\\\\windows\\\\system32\\\\tsmsisrv.dll')) OR endswith(lower(file.path), lower(':\\\\windows\\\\system32\\\\tsvipsrv.dll')) OR endswith(lower(file.path), lower(':\\\\windows\\\\system32\\\\wbem\\\\wbemcomn.dll')) OR endswith(lower(file.path), lower(':\\\\windows\\\\system32\\\\wlbsctrl.dll')) OR endswith(lower(file.path), lower(':\\\\windows\\\\system32\\\\wow64log.dll')) OR endswith(lower(file.path), lower(':\\\\windows\\\\system32\\\\wptsextensions.dll')) OR endswith(lower(file.path), lower('\\\\sprintcsp.dll'))))"
      }
    },
    "output": {
      "summary": "Detects the creation of system DLLs that are usually not present on the system (or at least not in system directories). Usually this technique is used to achieve DLL hijacking.",
      "defaultContext": true
    },
    "metadata": {
      "version": 1.0,
      "severity": "Medium",
      "fidelity": "Investigative",
      "objective": "False positive: Unknown References: https://decoded.avast.io/martinchlumecky/png-steganography/, https://posts.specterops.io/lateral-movement-scm-and-dll-hijacking-primer-d2f61e8ab992, https://clement.notin.org/blog/2020/09/12/CVE-2020-7315-McAfee-Agent-DLL-injection/, https://github.com/Wh04m1001/SysmonEoP, https://www.hexacorn.com/blog/2013/12/08/beyond-good-ol-run-key-part-5/, https://github.com/blackarrowsec/redteam-research/tree/26e6fc0c0d30d364758fa11c2922064a9a7fd309/LPE%20via%20StorSvc",
      "mitre": [
        {
          "taxonomy": "MITRE ATT&CK",
          "tactic": "Defense-Evasion",
          "techniqueId": "T1574",
          "subTechniqueId": "001"
        },
        {
          "taxonomy": "MITRE ATT&CK",
          "tactic": "Defense-Evasion",
          "techniqueId": "T1574",
          "subTechniqueId": "002"
        }
      ]
    },
    "computeMode": "high"
  },
  "apiVersion": "v1",
  "kind": "Rule"
}