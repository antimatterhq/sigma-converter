{
  "metadata": {
    "name": "Obfuscated IP Download Activity",
    "comment": "Detects use of an encoded/obfuscated version of an IP address (hex, octal...) in an URL combined with a download command",
    "annotations": {
      "source": "sigma",
      "category": "process_creation",
      "product": "windows",
      "sigma_status": "test"
    }
  },
  "spec": {
    "schedule": {
      "atLeastEvery": "12h",
      "enabled": false
    },
    "input": {
      "batch": {
        "sql": "SELECT * FROM process_activity WHERE time BETWEEN CURRENT_TIMESTAMP() - INTERVAL 24 HOUR AND CURRENT_TIMESTAMP() AND (activity_id = 1 AND (contains(lower(process.cmd_line), lower('invoke-webrequest')) OR contains(lower(process.cmd_line), lower('iwr ')) OR contains(lower(process.cmd_line), lower('wget ')) OR contains(lower(process.cmd_line), lower('curl ')) OR contains(lower(process.cmd_line), lower('downloadfile')) OR contains(lower(process.cmd_line), lower('downloadstring'))) AND (contains(lower(process.cmd_line), lower(' 0x')) OR contains(lower(process.cmd_line), lower('//0x')) OR contains(lower(process.cmd_line), lower('.0x')) OR contains(lower(process.cmd_line), lower('.00x')) OR contains(lower(process.cmd_line), lower('http://%')) AND contains(lower(process.cmd_line), lower('%2e')) OR process.cmd_line rlike 'https?://\\[0-9\\]\\{1,3\\}\\\\.\\[0-9\\]\\{1,3\\}\\\\.0\\[0-9\\]\\{3,4\\}' AND process.cmd_line rlike 'https?://\\[0-9\\]\\{1,3\\}\\\\.0\\[0-9\\]\\{3,7\\}' AND process.cmd_line rlike 'https?://0\\[0-9\\]\\{3,11\\}' AND process.cmd_line rlike 'https?://\\(0\\[0-9\\]\\{1,11\\}\\\\.\\)\\{3\\}0\\[0-9\\]\\{1,11\\}' AND process.cmd_line rlike 'https?://0\\[0-9\\]\\{1,11\\}' AND process.cmd_line rlike ' \\[0-7\\]\\{7,13\\}') AND NOT process.cmd_line rlike 'https?://\\(\\(25\\[0-5\\]|\\(2\\[0-4\\]|1\\\\d|\\[1-9\\]\\)?\\\\d\\)\\(\\\\.|\\\\b\\)\\)\\{4\\}')"
      }
    },
    "output": {
      "summary": "Detects use of an encoded/obfuscated version of an IP address (hex, octal...) in an URL combined with a download command",
      "defaultContext": true
    },
    "metadata": {
      "version": 1.0,
      "severity": "Medium",
      "fidelity": "Investigative",
      "objective": "False positive: Unknown References: https://h.43z.one/ipconverter/, https://twitter.com/Yasser_Elsnbary/status/1553804135354564608, https://twitter.com/fr0s7_/status/1712780207105404948",
      "mitre": [
        {
          "taxonomy": "MITRE ATT&CK",
          "tactic": "Discovery"
        }
      ]
    },
    "computeMode": "high"
  },
  "apiVersion": "v1",
  "kind": "Rule"
}