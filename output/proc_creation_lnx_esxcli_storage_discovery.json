{
  "metadata": {
    "name": "ESXi Storage Information Discovery Via ESXCLI",
    "comment": "Detects execution of the \"esxcli\" command with the \"storage\" flag in order to retrieve information about the storage status and other related information. Seen used by malware such as DarkSide and LockBit.",
    "annotations": {
      "source": "sigma",
      "category": "process_creation",
      "product": "linux",
      "sigma_status": "test"
    }
  },
  "spec": {
    "schedule": {
      "atLeastEvery": "12h",
      "enabled": false
    },
    "input": {
      "batch": {
        "sql": "SELECT * FROM process_activity WHERE time BETWEEN CURRENT_TIMESTAMP() - INTERVAL 24 HOUR AND CURRENT_TIMESTAMP() AND (lower(activity_id) = lower('1') AND endswith(lower(process.name), lower('/esxcli')) AND contains(lower(process.cmd_line), lower('storage')) AND (contains(lower(process.cmd_line), lower(' get')) OR contains(lower(process.cmd_line), lower(' list'))))"
      }
    },
    "output": {
      "summary": "Detects execution of the \"esxcli\" command with the \"storage\" flag in order to retrieve information about the storage status and other related information. Seen used by malware such as DarkSide and LockBit.",
      "defaultContext": true
    },
    "metadata": {
      "version": 1.0,
      "severity": "Medium",
      "fidelity": "Investigative",
      "objective": "False positive: Legitimate administration activities References: https://www.trendmicro.com/en_us/research/21/e/darkside-linux-vms-targeted.html, https://www.trendmicro.com/en_us/research/22/a/analysis-and-Impact-of-lockbit-ransomwares-first-linux-and-vmware-esxi-variant.html, https://developer.broadcom.com/xapis/esxcli-command-reference/7.0.0/namespace/esxcli_storage.html",
      "mitre": [
        {
          "taxonomy": "MITRE ATT&CK",
          "tactic": "Discovery",
          "techniqueId": "T1033"
        },
        {
          "taxonomy": "MITRE ATT&CK",
          "tactic": "Discovery",
          "techniqueId": "T1007"
        }
      ]
    },
    "computeMode": "high"
  },
  "apiVersion": "v1",
  "kind": "Rule"
}