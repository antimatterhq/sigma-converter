{
  "metadata": {
    "name": "Office Macro File Download",
    "comment": "Detects the creation of a new office macro files on the systems via an application (browser, mail client).",
    "annotations": {
      "source": "sigma",
      "category": "file_event",
      "product": "windows",
      "sigma_status": "test"
    }
  },
  "spec": {
    "schedule": {
      "atLeastEvery": "12h",
      "enabled": false
    },
    "input": {
      "batch": {
        "sql": "SELECT * FROM file_activity WHERE time BETWEEN CURRENT_TIMESTAMP() - INTERVAL 24 HOUR AND CURRENT_TIMESTAMP() AND (activity_id = 1 AND (endswith(lower(actor.process.name), lower('\\\\\\\\runtimebroker.exe')) OR endswith(lower(actor.process.name), lower('\\\\\\\\outlook.exe')) OR endswith(lower(actor.process.name), lower('\\\\\\\\thunderbird.exe')) OR endswith(lower(actor.process.name), lower('\\\\\\\\brave.exe')) OR endswith(lower(actor.process.name), lower('\\\\\\\\chrome.exe')) OR endswith(lower(actor.process.name), lower('\\\\\\\\firefox.exe')) OR endswith(lower(actor.process.name), lower('\\\\\\\\iexplore.exe')) OR endswith(lower(actor.process.name), lower('\\\\\\\\maxthon.exe')) OR endswith(lower(actor.process.name), lower('\\\\\\\\microsoftedge.exe')) OR endswith(lower(actor.process.name), lower('\\\\\\\\msedge.exe')) OR endswith(lower(actor.process.name), lower('\\\\\\\\msedgewebview2.exe')) OR endswith(lower(actor.process.name), lower('\\\\\\\\opera.exe')) OR endswith(lower(actor.process.name), lower('\\\\\\\\safari.exe')) OR endswith(lower(actor.process.name), lower('\\\\\\\\seamonkey.exe')) OR endswith(lower(actor.process.name), lower('\\\\\\\\vivaldi.exe')) OR endswith(lower(actor.process.name), lower('\\\\\\\\whale.exe'))) AND (endswith(lower(file.path), lower('.docm')) OR endswith(lower(file.path), lower('.dotm')) OR endswith(lower(file.path), lower('.xlsm')) OR endswith(lower(file.path), lower('.xltm')) OR endswith(lower(file.path), lower('.potm')) OR endswith(lower(file.path), lower('.pptm'))) AND (contains(lower(file.path), lower('.docm:zone')) OR contains(lower(file.path), lower('.dotm:zone')) OR contains(lower(file.path), lower('.xlsm:zone')) OR contains(lower(file.path), lower('.xltm:zone')) OR contains(lower(file.path), lower('.potm:zone')) OR contains(lower(file.path), lower('.pptm:zone'))))"
      }
    },
    "output": {
      "summary": "Detects the creation of a new office macro files on the systems via an application (browser, mail client).",
      "defaultContext": true
    },
    "metadata": {
      "version": 1.0,
      "severity": "Medium",
      "fidelity": "Investigative",
      "objective": "False positives: 1. Legitimate macro files downloaded from the internet 2. Legitimate macro files sent as attachments via emails References: https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1566.001/T1566.001.md, https://learn.microsoft.com/en-us/deployoffice/compat/office-file-format-reference",
      "mitre": [
        {
          "taxonomy": "MITRE ATT&CK",
          "tactic": "Initial-Access",
          "techniqueId": "T1566",
          "subTechniqueId": "001"
        }
      ]
    },
    "computeMode": "high"
  },
  "apiVersion": "v1",
  "kind": "Rule"
}