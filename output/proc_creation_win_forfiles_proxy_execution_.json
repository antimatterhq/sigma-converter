{
  "metadata": {
    "name": "Forfiles Command Execution",
    "comment": "Detects the execution of \"forfiles\" with the \"/c\" flag. While this is an expected behavior of the tool, it can be abused in order to proxy execution through it with any binary. Can be used to bypass application whitelisting.",
    "annotations": {
      "source": "sigma",
      "category": "process_creation",
      "product": "windows",
      "sigma_status": "test"
    }
  },
  "spec": {
    "schedule": {
      "atLeastEvery": "12h",
      "enabled": false
    },
    "input": {
      "batch": {
        "sql": "SELECT * FROM process_activity WHERE time BETWEEN CURRENT_TIMESTAMP() - INTERVAL 24 HOUR AND CURRENT_TIMESTAMP() AND (activity_id = 1 AND endswith(lower(process.name), lower('\\\\\\\\forfiles.exe')) AND lower(process.file.name) = lower('forfiles.exe') AND (contains(lower(process.cmd_line), lower(' -c ')) OR contains(lower(process.cmd_line), lower(' /c ')) OR contains(lower(process.cmd_line), lower(' \u2013c ')) OR contains(lower(process.cmd_line), lower(' \u2014c ')) OR contains(lower(process.cmd_line), lower(' \u2015c '))))"
      }
    },
    "output": {
      "summary": "Detects the execution of \"forfiles\" with the \"/c\" flag. While this is an expected behavior of the tool, it can be abused in order to proxy execution through it with any binary. Can be used to bypass application whitelisting.",
      "defaultContext": true
    },
    "metadata": {
      "version": 1.0,
      "severity": "Medium",
      "fidelity": "Investigative",
      "objective": "False positive: Legitimate use via a batch script or by an administrator. References: https://lolbas-project.github.io/lolbas/Binaries/Forfiles/, https://pentestlab.blog/2020/07/06/indirect-command-execution/",
      "mitre": [
        {
          "taxonomy": "MITRE ATT&CK",
          "tactic": "Execution",
          "techniqueId": "T1059"
        }
      ]
    },
    "computeMode": "high"
  },
  "apiVersion": "v1",
  "kind": "Rule"
}