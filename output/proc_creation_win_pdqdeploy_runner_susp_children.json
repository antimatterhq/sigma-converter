{
  "metadata": {
    "name": "Potentially Suspicious Execution Of PDQDeployRunner",
    "comment": "Detects suspicious execution of \"PDQDeployRunner\" which is part of the PDQDeploy service stack that is responsible for executing commands and packages on a remote machines",
    "annotations": {
      "source": "sigma",
      "category": "process_creation",
      "product": "windows",
      "sigma_status": "test"
    }
  },
  "spec": {
    "schedule": {
      "atLeastEvery": "12h",
      "enabled": false
    },
    "input": {
      "batch": {
        "sql": "SELECT * FROM process_activity WHERE time BETWEEN CURRENT_TIMESTAMP() - INTERVAL 24 HOUR AND CURRENT_TIMESTAMP() AND (activity_id = 1 AND contains(lower(process.parent_process.name), lower('\\\\\\\\pdqdeployrunner-')) AND (endswith(lower(process.name), lower('\\\\\\\\bash.exe')) OR endswith(lower(process.name), lower('\\\\\\\\certutil.exe')) OR endswith(lower(process.name), lower('\\\\\\\\cmd.exe')) OR endswith(lower(process.name), lower('\\\\\\\\csc.exe')) OR endswith(lower(process.name), lower('\\\\\\\\cscript.exe')) OR endswith(lower(process.name), lower('\\\\\\\\dllhost.exe')) OR endswith(lower(process.name), lower('\\\\\\\\mshta.exe')) OR endswith(lower(process.name), lower('\\\\\\\\msiexec.exe')) OR endswith(lower(process.name), lower('\\\\\\\\regsvr32.exe')) OR endswith(lower(process.name), lower('\\\\\\\\rundll32.exe')) OR endswith(lower(process.name), lower('\\\\\\\\scriptrunner.exe')) OR endswith(lower(process.name), lower('\\\\\\\\wmic.exe')) OR endswith(lower(process.name), lower('\\\\\\\\wscript.exe')) OR endswith(lower(process.name), lower('\\\\\\\\wsl.exe'))) AND (contains(lower(process.name), lower(':\\\\\\\\programdata\\\\\\\\')) OR contains(lower(process.name), lower(':\\\\\\\\users\\\\\\\\public\\\\\\\\')) OR contains(lower(process.name), lower(':\\\\\\\\windows\\\\\\\\temp\\\\\\\\')) OR contains(lower(process.name), lower('\\\\\\\\appdata\\\\\\\\local\\\\\\\\temp'))) AND (contains(lower(process.cmd_line), lower(' -decode ')) OR contains(lower(process.cmd_line), lower(' -enc ')) OR contains(lower(process.cmd_line), lower(' -encodedcommand ')) OR contains(lower(process.cmd_line), lower(' -w hidden')) OR contains(lower(process.cmd_line), lower('downloadstring')) OR contains(lower(process.cmd_line), lower('frombase64string')) OR contains(lower(process.cmd_line), lower('http')) OR contains(lower(process.cmd_line), lower('iex ')) OR contains(lower(process.cmd_line), lower('invoke-'))))"
      }
    },
    "output": {
      "summary": "Detects suspicious execution of \"PDQDeployRunner\" which is part of the PDQDeploy service stack that is responsible for executing commands and packages on a remote machines",
      "defaultContext": true
    },
    "metadata": {
      "version": 1.0,
      "severity": "Medium",
      "fidelity": "Investigative",
      "objective": "False positive: Legitimate use of the PDQDeploy tool to execute these commands Reference: https://twitter.com/malmoeb/status/1550483085472432128",
      "mitre": [
        {
          "taxonomy": "MITRE ATT&CK",
          "tactic": "Execution"
        }
      ]
    },
    "computeMode": "high"
  },
  "apiVersion": "v1",
  "kind": "Rule"
}