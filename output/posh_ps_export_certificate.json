{
  "metadata": {
    "name": "Certificate Exported Via PowerShell - ScriptBlock",
    "comment": "Detects calls to cmdlets inside of PowerShell scripts that are used to export certificates from the local certificate store. Threat actors were seen abusing this to steal private keys from compromised machines.",
    "annotations": {
      "source": "sigma",
      "category": "ps_script",
      "product": "windows",
      "sigma_status": "test"
    }
  },
  "spec": {
    "schedule": {
      "atLeastEvery": "15m",
      "enabled": true
    },
    "input": {
      "batch": {
        "sql": "SELECT * FROM script_activity WHERE time BETWEEN CURRENT_TIMESTAMP() - INTERVAL 24 HOUR AND CURRENT_TIMESTAMP() AND (lower(activity_id) = lower('1') AND (contains(lower(script.script_content.value), lower('export-pfxcertificate')) OR contains(lower(script.script_content.value), lower('export-certificate'))) AND NOT contains(lower(script.script_content.value), lower('cmdletstoexport = @(')))"
      }
    },
    "output": {
      "summary": "Detects calls to cmdlets inside of PowerShell scripts that are used to export certificates from the local certificate store. Threat actors were seen abusing this to steal private keys from compromised machines.",
      "defaultContext": true
    },
    "metadata": {
      "version": 1.0,
      "severity": "Medium",
      "fidelity": "Investigative",
      "objective": "False positive: Legitimate certificate exports by administrators. Additional filters might be required. References: https://us-cert.cisa.gov/ncas/analysis-reports/ar21-112a, https://learn.microsoft.com/en-us/powershell/module/pki/export-pfxcertificate?view=windowsserver2022-ps, https://www.splunk.com/en_us/blog/security/breaking-the-chain-defending-against-certificate-services-abuse.html",
      "mitre": [
        {
          "taxonomy": "MITRE ATT&CK",
          "tactic": "Credential-Access",
          "techniqueId": "T1552",
          "subTechniqueId": "004"
        }
      ]
    },
    "computeMode": "high"
  },
  "apiVersion": "v1",
  "kind": "Rule"
}