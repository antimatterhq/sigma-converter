{
  "metadata": {
    "name": "OMIGOD HTTP No Authentication RCE",
    "comment": "Detects the exploitation of OMIGOD (CVE-2021-38647) which allows remote execute (RCE) commands as root with just a single unauthenticated HTTP request. Verify, successful, exploitation by viewing the HTTP client (request) body to see what was passed to the server (using PCAP). Within the client body is where the code execution would occur. Additionally, check the endpoint logs to see if suspicious commands or activity occurred within the timeframe of this HTTP request.",
    "annotations": {
      "source": "sigma",
      "product": "zeek",
      "service": "http",
      "sigma_status": "stable"
    }
  },
  "spec": {
    "schedule": {
      "atLeastEvery": "12h",
      "enabled": false
    },
    "input": {
      "batch": {
        "sql": "SELECT * FROM http_activity WHERE time BETWEEN CURRENT_TIMESTAMP() - INTERVAL 24 HOUR AND CURRENT_TIMESTAMP() AND (activity_id = 6 AND CAST(http_response.code AS INT) = CAST(200 AS INT) AND lower(http_request.url) = lower('/wsman') AND lower(http_request.http_method) = lower('post') AND NOT exists(http_request.http_headers, x -> contains(lower(x.name), lower('authorization'))) AND NOT CAST(http_request.body_length AS INT) = CAST(0 AS INT))"
      }
    },
    "output": {
      "summary": "Detects the exploitation of OMIGOD (CVE-2021-38647) which allows remote execute (RCE) commands as root with just a single unauthenticated HTTP request. Verify, successful, exploitation by viewing the HTTP client (request) body to see what was passed to the server (using PCAP). Within the client body is where the code execution would occur. Additionally, check the endpoint logs to see if suspicious commands or activity occurred within the timeframe of this HTTP request.",
      "defaultContext": true
    },
    "metadata": {
      "version": 1.0,
      "severity": "High",
      "fidelity": "Investigative",
      "objective": "Examine fields: id.orig_h, dst_endpoint.ip, id.resp_p, http_response.code, http_request.http_method, http_request.url, http_request.body_length, response_body_len, http_request.user_agent False positives: 1. Exploits that were attempted but unsuccessful. 2. Scanning attempts with the abnormal use of the HTTP POST method with no indication of code execution within the HTTP Client (Request) body. An example would be vulnerability scanners trying to identify unpatched versions while not actually exploiting the vulnerability. See description for investigation tips. References: https://www.wiz.io/blog/omigod-critical-vulnerabilities-in-omi-azure, https://twitter.com/neu5ron/status/1438987292971053057?s=20",
      "mitre": [
        {
          "taxonomy": "MITRE ATT&CK",
          "tactic": "Privilege-Escalation",
          "techniqueId": "T1068"
        },
        {
          "taxonomy": "MITRE ATT&CK",
          "tactic": "Privilege-Escalation",
          "techniqueId": "T1190"
        },
        {
          "taxonomy": "MITRE ATT&CK",
          "tactic": "Privilege-Escalation",
          "techniqueId": "T1203"
        },
        {
          "taxonomy": "MITRE ATT&CK",
          "tactic": "Privilege-Escalation",
          "techniqueId": "T1021",
          "subTechniqueId": "006"
        },
        {
          "taxonomy": "MITRE ATT&CK",
          "tactic": "Privilege-Escalation",
          "techniqueId": "T1210"
        }
      ]
    },
    "computeMode": "high"
  },
  "apiVersion": "v1",
  "kind": "Rule"
}