title: Elevated System Shell Spawned From Uncommon Parent Location
id: 178e615d-e666-498b-9630-9ed363038101
status: test
level: medium
author: frack113, Tim Shelton (update fp)
description: Detects when a shell program such as the Windows command prompt or PowerShell
    is launched with system privileges from a uncommon parent location.
references:
    - https://github.com/Wh04m1001/SysmonEoP
falsepositives:
    - Unknown
tags:
    - attack.privilege-escalation
    - attack.defense-evasion
    - attack.execution
    - attack.t1059
date: '2022-12-05'
modified: '2023-11-23'
logsource:
    category: process_creation
    product: windows
detection:
    selection_shell:
        Image|endswith:
            - \powershell.exe
            - \pwsh.exe
            - \cmd.exe
        OriginalFileName:
            - PowerShell.EXE
            - pwsh.dll
            - Cmd.Exe
    selection_user:
        User|contains:
            - AUTHORI
            - AUTORI
        LogonId: '0x3e7'
    filter_main_generic:
        ParentImage|contains:
            - :\Program Files (x86)\
            - :\Program Files\
            - :\ProgramData\
            - :\Windows\System32\
            - :\Windows\SysWOW64\
            - :\Windows\Temp\
            - :\Windows\WinSxS\
    filter_optional_manageengine:
        ParentImage|endswith: :\ManageEngine\ADManager Plus\pgsql\bin\postgres.exe
        Image|endswith: \cmd.exe
    filter_optional_asgard:
        CommandLine|contains: :\WINDOWS\system32\cmd.exe /c "
        CurrentDirectory|contains: :\WINDOWS\Temp\asgard2-agent\
    filter_optional_ibm_spectrumprotect:
        ParentImage|contains: :\IBM\SpectrumProtect\webserver\scripts\
        CommandLine|contains: :\IBM\SpectrumProtect\webserver\scripts\
    filter_main_parent_null:
        ParentImage: null
    filter_main_parent_empty:
        ParentImage: ''
    condition: all of selection_* and not 1 of filter_main_* and not 1 of filter_optional_*
related:
    -   id: 61065c72-5d7d-44ef-bf41-6a36684b545f
        type: similar
ocsf_mapping:
    class_name: process_activity
    activity_id: 1
    logsource:
        category:
            source_field: category
            source_value: process_creation
            mapped_at: '2025-12-04T01:45:08.599699+00:00'
        product:
            source_field: product
            source_value: windows
            mapped_at: '2025-12-04T01:45:08.599699+00:00'
    detection_fields:
        -   source_field: Image
            target_table: process_activity
            target_field: process.name
            mapped_at: '2025-12-04T01:45:08.599714+00:00'
        -   source_field: OriginalFileName
            target_table: process_activity
            target_field: process.file.name
            mapped_at: '2025-12-04T01:45:08.599716+00:00'
        -   source_field: User
            target_table: process_activity
            target_field: actor.user.name
            mapped_at: '2025-12-04T01:45:08.599717+00:00'
        -   source_field: LogonId
            target_table: process_activity
            target_field: <UNMAPPED>
            mapped_at: '2025-12-04T01:45:08.599718+00:00'
        -   source_field: ParentImage
            target_table: process_activity
            target_field: process.parent_process.name
            mapped_at: '2025-12-04T01:45:08.599719+00:00'
        -   source_field: CommandLine
            target_table: process_activity
            target_field: process.cmd_line
            mapped_at: '2025-12-04T01:45:08.599720+00:00'
        -   source_field: CurrentDirectory
            target_table: process_activity
            target_field: <UNMAPPED>
            mapped_at: '2025-12-04T01:45:08.599721+00:00'
